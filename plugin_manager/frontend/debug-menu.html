<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœå•è°ƒè¯•é¡µé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        .warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-container>
                <h1>ğŸ”§ èœå•è°ƒè¯•é¡µé¢</h1>
                
                <v-alert type="info" class="mb-4">
                    è¿™ä¸ªé¡µé¢ç”¨äºè¯Šæ–­å·¦ä¾§èœå•ä¸æ˜¾ç¤ºçš„é—®é¢˜
                </v-alert>
                
                <div class="debug-section info">
                    <h2>æ­¥éª¤ 1: æ£€æŸ¥æ’ä»¶çŠ¶æ€</h2>
                    <v-btn @click="checkPluginStatus" color="primary" :loading="checkingStatus">æ£€æŸ¥æ’ä»¶çŠ¶æ€</v-btn>
                    <div v-if="pluginStatus" class="mt-4">
                        <pre>{{ JSON.stringify(pluginStatus, null, 2) }}</pre>
                    </div>
                </div>
                
                <div class="debug-section" :class="manifestStatus">
                    <h2>æ­¥éª¤ 2: æ£€æŸ¥Manifesté…ç½®</h2>
                    <v-btn @click="checkManifest" color="primary" :loading="checkingManifest">æ£€æŸ¥Manifest</v-btn>
                    <div v-if="manifestInfo" class="mt-4">
                        <h3>Frontend Pageé…ç½®ï¼š</h3>
                        <pre>{{ JSON.stringify(manifestInfo.frontend_page, null, 2) }}</pre>
                    </div>
                </div>
                
                <div class="debug-section" :class="cacheStatus">
                    <h2>æ­¥éª¤ 3: æ¸…é™¤ç¼“å­˜å’Œé‡æ–°åŠ è½½</h2>
                    <v-alert type="info" class="mb-4">
                        <strong>è¯´æ˜ï¼š</strong>æ¸…é™¤ç¼“å­˜å¯ä»¥è§£å†³ä¸‹è½½URLåŒ…å«.zipåç¼€çš„é—®é¢˜ã€‚
                    </v-alert>
                    <v-btn @click="clearCache" color="warning" :loading="clearingCache" class="mr-2">æ¸…é™¤ç¼“å­˜</v-btn>
                    <v-btn @click="forceReload" color="primary" :loading="reloading">å¼ºåˆ¶é‡æ–°åŠ è½½</v-btn>
                    <div v-if="cacheResult" class="mt-4">
                        <pre>{{ cacheResult }}</pre>
                    </div>
                </div>
                
                <div class="debug-section" :class="reloadConfigStatus">
                    <h2>æ­¥éª¤ 4: é‡æ–°åŠ è½½é…ç½®</h2>
                    <v-alert type="info" class="mb-4">
                        <strong>è¯´æ˜ï¼š</strong>é‡æ–°åŠ è½½æ’ä»¶é…ç½®ï¼Œå°è¯•åˆ·æ–°èœå•æ˜¾ç¤ºã€‚å¦‚æœèœå•ä»ç„¶ä¸æ˜¾ç¤ºï¼Œè¯·ç»§ç»­æ‰§è¡Œæ­¥éª¤5ã€‚
                    </v-alert>
                    <v-btn @click="reloadConfig" color="primary" :loading="reloadingConfig">é‡æ–°åŠ è½½é…ç½®</v-btn>
                    <div v-if="reloadConfigResult" class="mt-4">
                        <pre>{{ reloadConfigResult }}</pre>
                    </div>
                </div>
                
                <div class="debug-section" :class="restartStatus">
                    <h2>æ­¥éª¤ 5: é‡å¯NotifyHub</h2>
                    <v-alert type="warning" class="mb-4">
                        <strong>æ³¨æ„ï¼š</strong>é‡å¯NotifyHubæœåŠ¡å¯èƒ½ä¼šä¸­æ–­å½“å‰è¿æ¥ï¼Œè¯·ç¡®ä¿å·²ä¿å­˜æ‰€æœ‰å·¥ä½œã€‚
                    </v-alert>
                    <v-btn @click="restartNotifyHub" color="error" :loading="restarting">é‡å¯NotifyHub</v-btn>
                    <div v-if="restartResult" class="mt-4">
                        <pre>{{ restartResult }}</pre>
                    </div>
                </div>
                
                <div class="debug-section">
                    <h2>æ­¥éª¤ 6: æ‰‹åŠ¨è®¿é—®åº”ç”¨å•†åº—</h2>
                    <p>å¦‚æœèœå•ä»ç„¶ä¸æ˜¾ç¤ºï¼Œæ‚¨å¯ä»¥ç›´æ¥è®¿é—®åº”ç”¨å•†åº—ï¼š</p>
                    <v-btn @click="openAppStore" color="success" class="mr-2">æ‰“å¼€åº”ç”¨å•†åº—</v-btn>
                    <v-btn @click="copyAppStoreUrl" color="info">å¤åˆ¶é“¾æ¥</v-btn>
                    <div v-if="appStoreUrl" class="mt-4">
                        <p><strong>åº”ç”¨å•†åº—URLï¼š</strong></p>
                        <code>{{ appStoreUrl }}</code>
                    </div>
                </div>
                
                <div class="debug-section">
                    <h2>æ­¥éª¤ 7: æµ‹è¯•ä¸‹è½½åŠŸèƒ½</h2>
                    <v-btn @click="testDownload" color="primary" :loading="testingDownload">æµ‹è¯•ä¸‹è½½åŠŸèƒ½</v-btn>
                    <div v-if="downloadTestResult" class="mt-4">
                        <pre>{{ downloadTestResult }}</pre>
                    </div>
                </div>
            </v-container>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.8/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'light'
            }
        });

        createApp({
            data() {
                return {
                    pluginStatus: null,
                    manifestInfo: null,
                    restartResult: null,
                    cacheResult: null,
                    appStoreUrl: '/common/view?hidePadding=true#/api/plugins/plugin_manager/frontend/index.html',
                    downloadTestResult: null,
                    checkingStatus: false,
                    checkingManifest: false,
                    restarting: false,
                    clearingCache: false,
                    reloading: false,
                    reloadingConfig: false,
                    testingDownload: false,
                    manifestStatus: 'info',
                    restartStatus: 'info',
                    cacheStatus: 'info',
                    reloadConfigStatus: 'info',
                    reloadConfigResult: null
                }
            },
            
            methods: {
                async checkPluginStatus() {
                    this.checkingStatus = true;
                    try {
                        const response = await fetch('/api/plugins/plugin_manager/debug/info');
                        const data = await response.json();
                        this.pluginStatus = data;
                        console.log('æ’ä»¶çŠ¶æ€:', data);
                    } catch (error) {
                        this.pluginStatus = { error: error.message };
                        console.error('æ£€æŸ¥æ’ä»¶çŠ¶æ€å¤±è´¥:', error);
                    } finally {
                        this.checkingStatus = false;
                    }
                },
                
                async checkManifest() {
                    this.checkingManifest = true;
                    try {
                        // å°è¯•è·å–manifestä¿¡æ¯
                        const response = await fetch('/api/plugins/plugin_manager/debug/info');
                        const data = await response.json();
                        
                        // æ¨¡æ‹Ÿmanifestä¿¡æ¯ï¼ˆå®é™…åº”è¯¥ä»APIè·å–ï¼‰
                        this.manifestInfo = {
                            frontend_page: {
                                name: "åº”ç”¨å•†åº—",
                                icon: "mdi:store",
                                path: "/common/view?hidePadding=true#/api/plugins/plugin_manager/frontend/index.html",
                                add_to_menu: true
                            }
                        };
                        
                        this.manifestStatus = 'success';
                        console.log('Manifesté…ç½®æ£€æŸ¥å®Œæˆ');
                    } catch (error) {
                        this.manifestInfo = { error: error.message };
                        this.manifestStatus = 'error';
                        console.error('æ£€æŸ¥Manifestå¤±è´¥:', error);
                    } finally {
                        this.checkingManifest = false;
                    }
                },
                
                async clearCache() {
                    this.clearingCache = true;
                    try {
                        const response = await fetch('/api/plugins/plugin_manager/clear-cache', {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.cacheResult = JSON.stringify(data, null, 2);
                        this.cacheStatus = 'success';
                        console.log('ç¼“å­˜æ¸…é™¤æˆåŠŸ');
                    } catch (error) {
                        this.cacheResult = `æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`;
                        this.cacheStatus = 'error';
                        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
                    } finally {
                        this.clearingCache = false;
                    }
                },
                
                async forceReload() {
                    this.reloading = true;
                    try {
                        const response = await fetch('/api/plugins/plugin_manager/force-reload', {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.cacheResult = JSON.stringify(data, null, 2);
                        this.cacheStatus = 'success';
                        console.log('å¼ºåˆ¶é‡æ–°åŠ è½½æˆåŠŸ');
                        
                        // é‡æ–°æ£€æŸ¥æ’ä»¶çŠ¶æ€
                        await this.checkPluginStatus();
                    } catch (error) {
                        this.cacheResult = `å¼ºåˆ¶é‡æ–°åŠ è½½å¤±è´¥: ${error.message}`;
                        this.cacheStatus = 'error';
                        console.error('å¼ºåˆ¶é‡æ–°åŠ è½½å¤±è´¥:', error);
                    } finally {
                        this.reloading = false;
                    }
                },
                
                async reloadConfig() {
                    this.reloadingConfig = true;
                    this.reloadConfigResult = 'æ­£åœ¨é‡æ–°åŠ è½½é…ç½®...';
                    this.reloadConfigStatus = 'info';
                    
                    try {
                        const response = await fetch('/api/plugins/plugin_manager/reload-config', {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.reloadConfigResult = JSON.stringify(data, null, 2);
                        this.reloadConfigStatus = 'success';
                        
                        // é‡æ–°æ£€æŸ¥æ’ä»¶çŠ¶æ€
                        await this.checkPluginStatus();
                        
                        // æ˜¾ç¤ºæç¤º
                        alert('é…ç½®é‡æ–°åŠ è½½å®Œæˆï¼è¯·æ£€æŸ¥å·¦ä¾§èœå•æ˜¯å¦æ˜¾ç¤º"åº”ç”¨å•†åº—"ã€‚å¦‚æœä»ç„¶ä¸æ˜¾ç¤ºï¼Œè¯·ç»§ç»­æ‰§è¡Œæ­¥éª¤5é‡å¯NotifyHubã€‚');
                    } catch (error) {
                        this.reloadConfigResult = `é‡æ–°åŠ è½½é…ç½®å¤±è´¥: ${error.message}`;
                        this.reloadConfigStatus = 'error';
                        console.error('é‡æ–°åŠ è½½é…ç½®å¤±è´¥:', error);
                    } finally {
                        this.reloadingConfig = false;
                    }
                },
                
                async restartNotifyHub() {
                    if (!confirm('ç¡®å®šè¦é‡å¯NotifyHubæœåŠ¡å—ï¼Ÿè¿™å¯èƒ½ä¼šä¸­æ–­å½“å‰è¿æ¥ã€‚')) {
                        return;
                    }
                    
                    this.restarting = true;
                    try {
                        const response = await fetch('/api/plugins/plugin_manager/restart', {
                            method: 'POST'
                        });
                        const data = await response.json();
                        this.restartResult = JSON.stringify(data, null, 2);
                        this.restartStatus = 'success';
                        
                        // æ˜¾ç¤ºé‡å¯æç¤º
                        alert('NotifyHubæ­£åœ¨é‡å¯ï¼Œè¯·ç­‰å¾…å‡ ç§’é’Ÿååˆ·æ–°é¡µé¢æ£€æŸ¥èœå•æ˜¯å¦æ˜¾ç¤ºã€‚');
                    } catch (error) {
                        this.restartResult = `é‡å¯å¤±è´¥: ${error.message}`;
                        this.restartStatus = 'error';
                        console.error('é‡å¯NotifyHubå¤±è´¥:', error);
                    } finally {
                        this.restarting = false;
                    }
                },
                
                openAppStore() {
                    window.open(this.appStoreUrl, '_blank');
                },
                
                copyAppStoreUrl() {
                    navigator.clipboard.writeText(window.location.origin + this.appStoreUrl).then(() => {
                        alert('åº”ç”¨å•†åº—é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(() => {
                        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + this.appStoreUrl);
                    });
                },
                
                async testDownload() {
                    this.testingDownload = true;
                    try {
                        // æµ‹è¯•è·å–æ’ä»¶åˆ—è¡¨
                        const response = await fetch('/api/plugins/plugin_manager/plugins/search');
                        const data = await response.json();
                        
                        this.downloadTestResult = `æ‰¾åˆ° ${data.plugins.length} ä¸ªæ’ä»¶\n` + 
                                                 `å¤±è´¥ä»“åº“: ${data.failed_repositories || 'æ— '}\n` +
                                                 JSON.stringify(data, null, 2);
                    } catch (error) {
                        this.downloadTestResult = `æµ‹è¯•å¤±è´¥: ${error.message}`;
                    } finally {
                        this.testingDownload = false;
                    }
                }
            },
            
            async mounted() {
                console.log('èœå•è°ƒè¯•é¡µé¢å·²åŠ è½½');
                await this.checkPluginStatus();
                await this.checkManifest();
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>

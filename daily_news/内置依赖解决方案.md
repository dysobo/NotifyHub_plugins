# daily_news 插件内置依赖解决方案

## 问题描述

daily_news 插件的依赖包（zhdate、bs4、cryptography 等）总是下载失败，导致插件无法正常运行。

## 解决方案

### 1. 内置依赖包

已将以下依赖包下载并内置到 `vendor` 目录中：

- `zhdate-0.1-py3-none-any.whl` - 农历日期转换
- `beautifulsoup4-4.14.2-py3-none-any.whl` - HTML解析
- `cryptography-46.0.2-cp311-abi3-win_amd64.whl` - 加密库
- `pillow-11.3.0-cp312-cp312-win_amd64.whl` - 图像处理
- `requests-2.32.5-py3-none-any.whl` - HTTP请求
- `PyJWT-2.10.1-py3-none-any.whl` - JWT令牌处理
- 以及所有相关的依赖包

### 2. 自动安装机制

修改了 `daily_news.py` 文件，添加了自动安装本地依赖的功能：

```python
# 设置本地依赖路径
import sys
import os
import subprocess
from pathlib import Path

# 尝试从 vendor 目录安装依赖包
plugin_path = Path(__file__).parent
vendor_path = plugin_path / "vendor"
deps_path = plugin_path / "deps"

def install_local_deps():
    """从 vendor 目录安装依赖包到本地 deps 目录"""
    if not vendor_path.exists():
        return False
    
    # 创建 deps 目录
    deps_path.mkdir(exist_ok=True)
    
    # 获取所有 .whl 文件
    wheel_files = list(vendor_path.glob("*.whl"))
    if not wheel_files:
        return False
    
    # 安装依赖包到 deps 目录
    for wheel_file in wheel_files:
        try:
            subprocess.run([
                sys.executable, "-m", "pip", "install", 
                str(wheel_file), "--target", str(deps_path), "--no-deps", "--quiet"
            ], check=True)
        except subprocess.CalledProcessError:
            pass  # 忽略安装错误，继续尝试其他包
    
    # 将 deps 目录添加到 Python 路径
    if deps_path.exists() and str(deps_path) not in sys.path:
        sys.path.insert(0, str(deps_path))
        return True
    
    return False

# 尝试安装本地依赖
install_local_deps()
```

### 3. 文件结构

```
daily_news/
├── vendor/           # 内置依赖包目录（14个.whl文件）
├── deps/             # 自动生成的依赖安装目录
├── daily_news.py     # 主程序文件（已修改）
├── requirements.txt  # 依赖说明文件（已更新）
├── README_DEPS.md   # 依赖说明文档
└── 内置依赖解决方案.md  # 本文件
```

### 4. 工作原理

1. 插件启动时自动检查 `vendor` 目录
2. 如果找到依赖包，自动安装到 `deps` 目录
3. 将 `deps` 目录添加到 Python 路径中
4. 正常导入和使用依赖包

### 5. 优势

- ✅ 无需网络连接即可安装依赖
- ✅ 避免依赖下载失败问题
- ✅ 版本固定，避免兼容性问题
- ✅ 插件开箱即用
- ✅ 自动处理依赖关系

### 6. 测试结果

已通过测试，所有依赖包都能正常导入：

```
BeautifulSoup 导入成功
PIL (Pillow) 导入成功
requests 导入成功
PyJWT 导入成功
zhdate 导入成功
cryptography 导入成功
所有依赖包测试通过！
```

### 7. 注意事项

- `vendor` 目录中的依赖包是预下载的，请勿删除
- `deps` 目录是自动生成的，可以删除（插件会重新创建）
- 如果遇到问题，可以删除 `deps` 目录让插件重新安装依赖
- 此解决方案适用于 Windows 平台，其他平台可能需要重新下载对应平台的依赖包

## 总结

通过内置依赖包的方式，彻底解决了 daily_news 插件的依赖下载问题，使插件能够稳定运行，无需担心网络问题导致的依赖安装失败。

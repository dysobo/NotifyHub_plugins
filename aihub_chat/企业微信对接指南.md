# AIHub 智能对话插件 - 企业微信对接指南

## 📋 概述

本插件已完整支持企业微信对接，包括：
- ✅ 消息加密解密
- ✅ URL 验证
- ✅ 接收文本、图片、语音消息
- ✅ 主动发送文本、图片、语音消息
- ✅ 媒体文件上传下载

## 🔑 准备工作

### 1. 获取企业微信配置信息

登录企业微信管理后台：https://work.weixin.qq.com

#### 1.1 获取 CorpID（企业ID）
- 位置：**我的企业** → **企业信息** → **企业ID**
- 示例：`ww239ef8d083b060c3`

#### 1.2 创建应用并获取信息
1. 进入：**应用管理** → **应用** → **创建应用**
2. 填写应用信息并创建
3. 进入应用详情页，获取：
   - **AgentId**（应用ID）：示例 `1000016`
   - **Secret**（应用密钥）：示例 `ce6T2VLaTwYBaVtuGdE0V6e0ui1GlpvllzsaIEC0JXc`

#### 1.3 配置接收消息
在应用详情页，找到 **接收消息** 设置：

1. **URL**（接收消息地址）：
   ```
   https://your-domain.com/api/plugins/aihub_chat/wxwork
   ```

2. **Token**（自定义）：
   - 自行设置，用于消息签名验证
   - 示例：`fFPNTlg`

3. **EncodingAESKey**（随机生成）：
   - 点击"随机生成"按钮
   - 示例：`xV2yZaA4vJHFhDdCBcRtYqW9kP3mS8nU5eL7oN1iG6j`

4. 点击"保存"，系统会进行 URL 验证

## ⚙️ 插件配置

### 在 NotifyHub 管理界面配置

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| **启用企业微信对接** | 开关 | ✅ 打开 |
| **企业微信 API 地址** | 官方 API 地址 | `https://qyapi.weixin.qq.com` |
| **企业微信 CorpID** | 企业ID | `ww239ef8d083b060c3` |
| **企业微信 Secret** | 应用密钥 | `ce6T2VLaTwYBaVtuGdE0V6e0ui1GlpvllzsaIEC0JXc` |
| **企业微信 AgentID** | 应用ID | `1000016` |
| **企业微信 Token** | 消息Token | `fFPNTlg` |
| **企业微信 EncodingAESKey** | 消息密钥 | `xV2yZaA4vJHFhDdCBcRtYqW9kP3mS8nU5eL7oN1iG6j` |

### 完整配置示例

```json
{
  "api_base_url": "https://aihubmix.com/v1",
  "api_key": "sk-your-aihubmix-key",
  "chat_model": "gpt-4o-mini",
  "image_model": "dall-e-3",
  "enable_web_search": true,
  "enable_tts": true,
  "enable_stt": true,
  "enable_wxwork": true,
  "wxwork_api_base": "https://qyapi.weixin.qq.com",
  "wxwork_corp_id": "ww239ef8d083b060c3",
  "wxwork_secret": "ce6T2VLaTwYBaVtuGdE0V6e0ui1GlpvllzsaIEC0JXc",
  "wxwork_agent_id": "1000016",
  "wxwork_token": "fFPNTlg",
  "wxwork_encoding_aes_key": "xV2yZaA4vJHFhDdCBcRtYqW9kP3mS8nU5eL7oN1iG6j"
}
```

## 🔄 对接流程

### 流程图

```
企业微信应用 ←→ NotifyHub 插件 ←→ AIHubMix 平台
     ↓                  ↓                    ↓
1. 发送消息          2. 解密处理           3. AI 处理
4. 接收加密消息      5. 加密/主动发送      6. 返回结果
```

### 详细步骤

#### 1. URL 验证（首次配置）
```
1. 企业微信发送 GET 请求到插件
   参数：msg_signature, timestamp, nonce, echostr
   
2. 插件验证签名并解密 echostr
   
3. 返回解密后的 echostr
   
4. 验证成功 ✅
```

#### 2. 消息接收（运行时）
```
1. 用户在企业微信发送消息
   
2. 企业微信加密消息并 POST 到插件
   
3. 插件解密消息并提取内容
   
4. 调用 AI 处理消息
   
5. 通过企业微信 API 主动发送回复
```

## 📱 支持的消息类型

### 接收消息

| 类型 | 企业微信格式 | 插件处理 |
|------|-------------|----------|
| **文本** | `MsgType=text` | 直接对话或命令解析 |
| **图片** | `MsgType=image, MediaId` | 下载图片 → AI 分析 |
| **语音** | `MsgType=voice, MediaId` | 下载语音 → STT → 处理 |

### 发送消息

| 类型 | 使用场景 | API |
|------|---------|-----|
| **文本** | AI 回复 | `send_text_message` |
| **图片** | 生成图片、分析结果 | `send_image_message` |
| **语音** | TTS 语音合成 | `send_voice_message` |

## 🎯 使用示例

### 场景 1：文本对话

**用户发送：**
```
你好，介绍一下 Python
```

**插件处理：**
1. 接收并解密消息
2. 调用 AIHubMix API 对话
3. 主动发送文本回复

**用户收到：**
```
Python 是一种广泛使用的高级编程语言...
```

---

### 场景 2：图片分析

**用户发送：**
- [发送一张菜单图片]

**插件处理：**
1. 接收图片消息
2. 通过 MediaId 下载图片
3. 调用 AI 视觉模型分析
4. 发送分析结果

**用户收到：**
```
🖼️ 图片分析：

这是一份中餐菜单，包含以下菜品：
1. 宫保鸡丁 - ¥38
2. 麻婆豆腐 - ¥28
...
```

---

### 场景 3：图片生成

**用户发送：**
```
/draw 一只可爱的橘猫在草地上玩耍
```

**插件处理：**
1. 解析命令
2. 调用 DALL-E 生成图片
3. 下载图片
4. 上传到企业微信
5. 发送图片消息

**用户收到：**
- [AI 生成的猫咪图片]
- `🎨 图片生成完成：一只可爱的橘猫在草地上玩耍`

---

### 场景 4：语音识别

**用户发送：**
- [语音："明天北京天气怎么样"]

**插件处理：**
1. 接收语音消息
2. 下载语音文件
3. Whisper STT 转文本
4. AI 处理问题
5. 发送文本回复

**用户收到：**
```
🎤 识别结果：明天北京天气怎么样

正在处理...

🔍 根据最新天气信息，明天北京...
```

---

### 场景 5：语音合成

**用户发送：**
```
/tts 欢迎使用 AI 智能助手
```

**插件处理：**
1. 解析命令
2. TTS 生成语音
3. 上传到企业微信
4. 发送语音消息

**用户收到：**
- [语音播放："欢迎使用 AI 智能助手"]

## 🔧 API 端点

### 1. 企业微信消息接收
```
GET/POST /api/plugins/aihub_chat/wxwork
```

**参数：**
- `msg_signature`: 消息签名
- `timestamp`: 时间戳
- `nonce`: 随机数
- `echostr`: 验证字符串（仅 GET）

**GET 请求**：URL 验证
**POST 请求**：接收消息

---

### 2. 状态检查
```
GET /api/plugins/aihub_chat/status
```

**返回示例：**
```json
{
  "plugin": "aihub_chat",
  "timestamp": "2024-10-16T22:45:00",
  "config": {
    "enable_wxwork": true,
    "has_api_key": true,
    "chat_model": "gpt-4o-mini"
  }
}
```

## 🐛 故障排查

### 问题 1：URL 验证失败

**现象：** 企业微信提示"验证失败"

**排查步骤：**
1. 检查插件配置：
   - ✅ Token 是否正确
   - ✅ EncodingAESKey 是否正确
   - ✅ CorpID 是否正确

2. 查看插件日志：
   ```bash
   docker logs notifyhub | grep wxwork
   ```

3. 测试接口可达性：
   ```bash
   curl "https://your-domain.com/api/plugins/aihub_chat/ping"
   ```

**常见原因：**
- EncodingAESKey 配置错误
- Token 不匹配
- 签名验证失败

---

### 问题 2：收不到消息

**现象：** 发送消息没有回复

**排查步骤：**
1. 检查应用权限：
   - 进入企业微信应用管理
   - 确认应用可见范围包含用户

2. 检查插件日志：
   ```bash
   docker logs -f notifyhub | grep "WXWork message"
   ```

3. 测试解密功能：
   - 查看是否有解密失败日志
   - 确认 EncodingAESKey 正确

---

### 问题 3：无法主动发送消息

**现象：** 插件无法向用户发送消息

**排查步骤：**
1. 检查配置：
   - ✅ CorpID
   - ✅ Secret
   - ✅ AgentID

2. 测试 access_token：
   ```bash
   curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=YOUR_CORPID&corpsecret=YOUR_SECRET"
   ```

3. 查看 API 错误：
   ```bash
   docker logs notifyhub | grep "WXWork API"
   ```

**常见原因：**
- Secret 过期或错误
- AgentID 不匹配
- API 权限不足

---

### 问题 4：图片/语音发送失败

**现象：** 生成的图片或语音无法发送

**排查步骤：**
1. 检查媒体上传：
   ```bash
   ls -la data/plugins/aihub_chat/media/
   ```

2. 检查日志：
   ```bash
   docker logs notifyhub | grep "upload_media"
   ```

3. 确认文件格式：
   - 图片：jpg, png（< 2MB）
   - 语音：amr, mp3（< 2MB）

**解决方案：**
- 检查文件大小
- 确认格式支持
- 查看上传返回的 media_id

## 📊 日志说明

### 正常日志示例

```
[INFO] WXWork URL verification successful
[INFO] Received WXWork message: {"MsgType":"text","Content":"你好"}
[INFO] WXWork access_token refreshed
[INFO] Sent text message to user123
[INFO] Uploaded media: media_id_xxx
```

### 错误日志示例

```
[ERROR] Signature verification failed
[ERROR] Decryption failed: Invalid AES key
[ERROR] Failed to get access_token: {"errcode":40013}
[ERROR] WXWork API not available
```

## 🔐 安全建议

1. **保护敏感信息**
   - ❌ 不要在日志中输出 Secret
   - ❌ 不要在前端暴露 EncodingAESKey
   - ✅ 使用环境变量存储密钥

2. **定期更新**
   - 🔄 定期轮换 Secret
   - 🔄 更新 EncodingAESKey

3. **访问控制**
   - 🔒 限制应用可见范围
   - 🔒 配置 IP 白名单（如支持）

## 📈 性能优化

1. **access_token 缓存**
   - 自动缓存，7200秒有效期
   - 提前5分钟刷新

2. **媒体文件管理**
   - 定期清理过期文件
   - 建议保留最近7天

3. **并发控制**
   - 避免频繁调用 API
   - 合理设置超时时间

## 🎉 完成！

配置完成后，您可以：

1. **测试对话**
   ```
   在企业微信应用中发送：你好
   ```

2. **测试图片生成**
   ```
   发送：/draw 一朵玫瑰花
   ```

3. **测试语音**
   ```
   发送语音消息或：/tts 测试语音
   ```

4. **查看统计**
   - 访问管理面板查看使用情况
   - 查看日志了解运行状态

---

**问题反馈**：如有问题，请查看日志或联系技术支持。

**参考文档**：
- [企业微信开发文档](https://developer.work.weixin.qq.com/)
- [AIHubMix 文档](https://docs.aihubmix.com/cn)
- [插件 README](./README.md)


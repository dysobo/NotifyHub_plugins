# 更新日志

## v0.0.2 (2024-10-17)

### ✨ 新功能

#### 🌐 实时联网搜索
- 集成 AIHubMix Surfing 功能（基于 Tavily 搜索引擎）
- 支持获取最新价格、天气、新闻等实时信息
- 模型使用 `:surfing` 后缀启用搜索
- 自动包含信息来源链接

### 🔧 优化改进

#### 用户体验优化
- 优化搜索系统提示词，更自然灵活
- 移除费用显示，界面更简洁
- 搜索回复改为"实时搜索"（原"知识库回答"）

#### 文档完善
- 完善 ffmpeg 和 AMR 编码器安装说明
- 在 README 顶部添加依赖安装警告
- 说明为什么需要这些依赖
- 整合核心文档，删除冗余内容

### 🐛 Bug修复

- 无新 Bug（v0.0.1 已修复所有已知问题）

---

## v0.0.1 (2024-10-16)

### ✨ 新功能

#### 🤖 AI 对话
- 支持多种大语言模型（GPT-4、Claude、Gemini、DeepSeek、通义千问）
- 自动维护对话历史（最近10轮）
- 支持自定义系统提示词
- 可调节温度和 Token 参数

#### 🖼️ 图片功能
- **图片分析**：发送图片让 AI 进行内容识别、OCR、场景理解
- **图片生成**：支持 DALL-E 3/2、Ideogram V2
- **智能识别**：语音说"画一只猫"自动识别为绘画命令

#### 🎤 语音功能
- **STT（语音转文本）**：基于 Whisper 模型的高精度识别
- **格式转换**：自动将企业微信 AMR 格式转换为 MP3
- **TTS（文本转语音）**：支持 6 种语音
- **智能识别**：语音说"朗读这段话"自动识别为 TTS 命令

#### 🔍 智能搜索
- 使用 AI 知识库回答问题
- 支持 /search 命令

#### 📱 企业微信对接
- 完整的消息加密解密支持
- URL 验证
- 接收文本、图片、语音消息
- 主动发送文本、图片、语音消息
- 媒体文件上传下载

### 🔧 技术改进

#### 消息去重
- 防止企业微信重复发送消息导致多次回复
- 基于 MsgId 的智能去重机制
- 自动清理过期消息ID（最多保存1000个）

#### 命令增强
- **大小写不敏感**：`/TTS`、`/Draw`、`/SEARCH` 都能识别
- **智能意图识别**：
  - 语音说"画一只猫" → 自动生成图片
  - 语音说"朗读这段话" → 自动转语音
  - 不需要记住复杂的命令格式

#### 异步优化
- 正确使用 AsyncOpenAI 的异步方法
- 音频转换使用异步线程避免阻塞
- 优化响应速度

### 🐛 已修复的问题

1. **图片重复回复** ✅
   - 问题：发送一张图片收到三次回复
   - 原因：企业微信消息重复发送
   - 解决：添加消息去重机制

2. **语音识别失败** ✅
   - 问题：`'coroutine' object has no attribute 'text'`
   - 原因：错误使用 asyncio.to_thread 包装异步方法
   - 解决：直接 await 异步方法

3. **AMR 格式不支持** ✅
   - 问题：企业微信 AMR 语音 Whisper 无法识别
   - 原因：Whisper 不支持 AMR 格式
   - 解决：使用 pydub + ffmpeg 自动转换为 MP3

4. **命令大小写敏感** ✅
   - 问题：`/TTS` 大写无法识别
   - 原因：命令匹配区分大小写
   - 解决：统一转小写匹配

5. **语音绘画无法识别** ✅
   - 问题：语音说"画一只猫"不触发绘画
   - 原因：只匹配 /draw 命令
   - 解决：添加智能意图识别

### 📦 依赖

```txt
aiohttp>=3.9.0
aiofiles>=23.0.0
openai>=1.12.0
Pillow>=10.0.0
pycryptodome>=3.18.0
xmltodict>=0.13.0
pydub>=0.25.1
```

### ⚙️ 系统依赖

- **ffmpeg**（必需）：用于 AMR 音频格式转换

### 📝 配置项

#### 必需配置
- AIHubMix API 地址
- AIHubMix API Key
- 企业微信配置（7项）

#### 可选配置
- 对话模型选择
- 图片生成模型
- 系统提示词
- 温度参数
- Token 限制
- 功能开关（TTS、STT、搜索）

### 🎯 支持的命令

#### 标准命令（大小写不敏感）
- `/draw 描述` 或 `/DRAW 描述` - 生成图片
- `/tts 文字` 或 `/TTS 文字` - 文本转语音
- `/search 问题` 或 `/SEARCH 问题` - 智能搜索
- `/clear` 或 `/CLEAR` - 清空历史

#### 中文命令
- `/画图 描述` - 生成图片
- `/语音 文字` - 文本转语音
- `/搜索 问题` - 智能搜索
- `/清空` - 清空历史

#### 智能识别（语音输入）
- "画一只猫" → 生成图片
- "帮我画个风景" → 生成图片
- "朗读这段文字" → 转语音
- "转成语音说你好" → 转语音

### 🔗 API 端点

- `GET /api/plugins/aihub_chat/ping` - 健康检查
- `GET /api/plugins/aihub_chat/status` - 状态信息
- `POST /api/plugins/aihub_chat/test` - 测试连接
- `GET/POST /api/plugins/aihub_chat/wxwork` - 企业微信消息
- `GET /api/plugins/aihub_chat/media/{filename}` - 媒体文件

### 👥 贡献者

- **dysobo** - 主要开发

### 📄 许可证

MIT License

---

## 计划中的功能

### v0.0.2
- [ ] 对话历史持久化（数据库存储）
- [ ] 多用户会话管理优化
- [ ] 更多语音合成声音
- [ ] 图片编辑功能
- [ ] 视频处理支持

### v0.1.0
- [ ] 插件市场发布
- [ ] 完整的管理界面
- [ ] 使用统计和分析
- [ ] 成本追踪
- [ ] 多语言支持

---

**开发团队**: dysobo  
**初始发布**: 2024-10-16  
**当前版本**: 0.0.1


# AIHub 智能对话插件

一个功能强大的 NotifyHub 插件，对接 [AIHubMix](https://aihubmix.com) 平台，提供 AI 对话、图片处理、语音功能和实时 Web 搜索等能力。

**版本**: 0.0.2  
**作者**: dysobo  
**发布日期**: 2024-10-17

## ⚠️ 重要：安装依赖

### 必需依赖：ffmpeg + AMR 编码器

本插件的语音功能需要 **ffmpeg** 和 **AMR 编码器**支持：

```bash
# Docker 环境（推荐）
docker exec -it notifyhub apt-get update
docker exec -it notifyhub apt-get install -y ffmpeg libavcodec-extra libopencore-amrnb0 libopencore-amrwb0

# 验证安装
docker exec -it notifyhub ffmpeg -codecs | grep amr

# 重启服务
docker restart notifyhub
```

**为什么需要？**
- **接收语音**：企业微信语音是 AMR 格式，需转换为 MP3 才能用 Whisper 识别
- **发送语音**：TTS 生成 MP3，企业微信只接受 AMR 格式，需要转换

**不安装会怎样？**
- 语音识别功能无法使用
- 语音合成只能发送链接，无法直接播放

## ✨ 功能特性

### 🤖 多模型对话
- **OpenAI 系列**：GPT-4o、GPT-4o Mini
- **Anthropic 系列**：Claude 3.5 Sonnet、Claude 3.5 Haiku
- **Google 系列**：Gemini 2.0 Flash
- **DeepSeek**：DeepSeek Chat
- **阿里云**：通义千问 Max

### 🖼️ 图片功能
- **图片分析**：发送图片让 AI 进行内容识别、OCR、场景理解
- **图片生成**：
  - DALL-E 3/2（OpenAI）
  - Ideogram V2（Ideogram AI）

### 🎤 语音功能
- **STT（语音转文本）**：基于 Whisper 模型的高精度语音识别
- **TTS（文本转语音）**：支持 6 种语音（Alloy、Echo、Fable、Onyx、Nova、Shimmer）

### 🔍 实时搜索（⚠️ 测试中）
- **AIHubMix Surfing**：联网搜索功能（基于 Tavily）
- 尝试获取最新价格、天气、新闻等实时信息
- ⚠️ 注意：该功能正在完善中，搜索结果可能不完全准确或为历史数据

### 🧠 智能识别
- **语音绘画**：语音说"画一只猫"自动生成图片
- **语音 TTS**：语音说"朗读这段话"自动转语音
- **命令大小写**：`/TTS`、`/Draw`、`/SEARCH` 都支持

## 📦 安装配置

### 1. 安装插件

将插件文件夹放置到 NotifyHub 的 `/data/plugins/` 目录下：

```
/data/plugins/aihub_chat/
├── __init__.py
├── aihub_chat.py
├── manifest.json
├── requirements.txt
├── README.md
└── frontend/
    └── index.html
```

### 2. 配置 AIHubMix

1. 访问 [AIHubMix 平台](https://aihubmix.com)
2. 注册账号并充值
3. 在「Keys」页面创建 API Key
4. 复制 API Key（格式：`sk-***`）

### 3. 安装系统依赖（语音功能必需）

语音功能需要 **ffmpeg** 支持音频格式转换：

**Docker 环境**：
```bash
docker exec -it notifyhub apt-get update
docker exec -it notifyhub apt-get install -y ffmpeg
```

**其他系统**：
- Ubuntu/Debian: `sudo apt-get install -y ffmpeg`
- macOS: `brew install ffmpeg`
- Windows: 下载并添加到 PATH

详见：[语音功能说明.md](./语音功能说明.md)

### 4. 插件配置

在 NotifyHub 管理界面配置插件：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| AIHubMix API 地址 | API 基础地址 | `https://aihubmix.com/v1` |
| API Key | 平台 API Key | `sk-***` |
| 对话模型 | 选择对话模型 | `gpt-4o-mini` |
| 图片生成模型 | 选择图片模型 | `dall-e-3` |
| 启用智能搜索 | AI 知识库问答 | ✅ |
| 启用 TTS | 文本转语音 | ✅ |
| 启用 STT | 语音转文本 | ✅ |
| 系统提示词 | AI 角色定义 | 自定义 |

### 5. 配置企业微信

在企业微信应用管理后台配置接收消息 URL：

```
https://your-domain.com/api/plugins/aihub_chat/wxwork
```

详细配置步骤请参考：[企业微信对接指南.md](./企业微信对接指南.md)

## 🎯 使用方法

### 命令列表

| 命令 | 功能 | 示例 | 智能识别 |
|------|------|------|---------|
| 直接发送文字 | 普通对话 | `你好，今天天气怎么样？` | - |
| 发送图片 | 图片分析 | 直接发送图片 | - |
| `/draw <描述>` | 生成图片 | `/draw 一只可爱的猫咪` | ✅ 支持大小写 |
| `/画图 <描述>` | 生成图片 | `/画图 赛博朋克城市` | - |
| **语音："画XX"** | 智能绘画 | 语音："画一只小狗" | ⭐ 自动识别 |
| `/search <问题>` | 实时搜索 | `/search 黄金最新价格` | ✅ 支持大小写 |
| `/搜索 <问题>` | 实时搜索 | `/搜索 今天北京天气` | - |
| `/tts <文字>` | 文字转语音 | `/tts 你好世界` | ✅ 支持大小写 |
| `/语音 <文字>` | 文字转语音 | `/语音 今天是个好日子` | - |
| **语音："朗读XX"** | 智能TTS | 语音："朗读这段话" | ⭐ 自动识别 |
| 发送语音 | 语音识别 | 直接发送语音消息 | ✅ 自动处理 |
| `/clear` | 清空历史 | `/clear` 或 `/CLEAR` | ✅ 支持大小写 |

### 使用场景

#### 1. 日常对话
```
用户：介绍一下量子计算
AI：量子计算是一种利用量子力学原理进行信息处理的新型计算方式...
```

#### 2. 图片分析
```
用户：[发送一张菜单图片]
AI：这是一份西餐菜单，包含以下内容：
1. 前菜：凯撒沙拉、法式洋葱汤
2. 主菜：牛排、三文鱼...
```

#### 3. 图片生成
```
用户：/draw 一座未来科技城市，有飞行汽车和摩天大楼
AI：🎨 图片生成完成：一座未来科技城市，有飞行汽车和摩天大楼
[返回生成的图片链接]
```

#### 4. Web 搜索
```
用户：/search 今天北京天气
AI：🔍 搜索结果：
根据最新天气信息，今天北京...
```

#### 5. 语音功能
```
用户：[发送语音："明天的会议安排"]
AI：🎤 识别结果：明天的会议安排
关于明天的会议安排，我需要更多具体信息...

用户：/tts 请在明天上午9点参加技术评审会议
AI：🔊 语音已生成：请在明天上午9点参加技术评审会议
[返回语音文件链接]
```

## 🔧 API 接口

### 状态检查
```http
GET /api/plugins/aihub_chat/status
```

返回插件状态、配置信息和使用统计。

### 测试发送
```http
POST /api/plugins/aihub_chat/test
```

发送测试消息，验证插件配置是否正确。

### Webhook 接收
```http
POST /api/plugins/aihub_chat/webhook
```

接收来自企业微信或其他平台的消息。

### 媒体文件访问
```http
GET /api/plugins/aihub_chat/media/{filename}
```

访问生成或下载的媒体文件。

## 📊 数据存储

- **对话历史**：内存存储（每个用户保留最近 10 轮对话）
- **媒体文件**：存储在 `/data/plugins/aihub_chat/media/` 目录
  - 图片：`.jpg`, `.png`, `.gif`, `.webp`
  - 语音：`.mp3`, `.wav`, `.ogg`
  - 自动清理策略：建议定期清理旧文件

## 🎨 高级配置

### 系统提示词示例

**通用助手**：
```
你是一个智能助手，能够回答问题、分析图片、生成内容。请用简洁、友好的方式回复用户。
```

**专业顾问**：
```
你是一位资深的技术顾问，擅长解决编程、架构设计和技术选型问题。请提供专业、详细的技术建议。
```

**创意助手**：
```
你是一位富有创意的内容创作者，擅长写作、设计和创意构思。请用生动、有趣的方式帮助用户实现创意想法。
```

### 温度参数说明

| 温度值 | 特点 | 适用场景 |
|--------|------|----------|
| 0.0-0.3 | 确定性强，回复一致 | 技术问答、数据分析 |
| 0.4-0.7 | 平衡创意与准确性 | 日常对话、内容创作 |
| 0.8-1.0 | 创意性强，多样化 | 创意写作、头脑风暴 |
| 1.1-2.0 | 极高随机性 | 实验性场景 |

### 最大 Token 配置

| Token 数 | 约字数（中文） | 适用场景 |
|----------|----------------|----------|
| 500 | ~250 字 | 简短回复 |
| 1000 | ~500 字 | 常规对话 |
| 2000 | ~1000 字 | 详细解答 |
| 4000 | ~2000 字 | 长文写作 |

## 🔐 安全建议

1. **API Key 保护**：
   - 不要在公共场所暴露 API Key
   - 定期轮换 API Key
   - 为不同应用使用不同的 Key

2. **访问控制**：
   - 配置允许的用户/群组白名单
   - 限制 Webhook 访问来源
   - 启用消息签名验证（如支持）

3. **内容过滤**：
   - AIHubMix 自带内容审核
   - 避免请求敏感内容（暴力、色情、政治）
   - 配置合适的系统提示词引导 AI 行为

## 📈 性能优化

1. **对话历史管理**：
   - 默认保留 10 轮对话
   - 使用 `/clear` 命令清空历史
   - 长对话可能增加 Token 消耗

2. **媒体文件管理**：
   - 定期清理过期媒体文件
   - 建议设置文件过期策略
   - 大文件可能影响响应速度

3. **模型选择**：
   - 日常对话：`gpt-4o-mini` 或 `claude-3-5-haiku`（快速、经济）
   - 复杂任务：`gpt-4o` 或 `claude-3-5-sonnet`（强大、准确）
   - 图片生成：`dall-e-3`（高质量）

## 🐛 故障排查

### 问题 1：API Key 无效
- **检查**：确认 API Key 格式正确（`sk-***`）
- **解决**：重新从 AIHubMix 平台获取 Key

### 问题 2：图片分析失败
- **检查**：确认使用支持视觉的模型（如 `gpt-4o`）
- **解决**：切换到支持多模态的模型

### 问题 3：语音功能不可用
- **检查**：确认启用了 TTS/STT 开关
- **解决**：在插件配置中启用对应功能

### 问题 4：Web 搜索无结果
- **检查**：确认启用了 Web 搜索功能
- **解决**：检查 AIHubMix 账户是否支持联网搜索

### 问题 5：消息发送失败
- **检查**：确认配置了正确的通道或渠道
- **解决**：在插件配置中重新选择发送目标

## 📝 更新日志

### v0.0.2 (2024-10-17)
- ✅ 集成 AIHubMix Surfing 实时搜索（基于 Tavily）
- ✅ 优化搜索提示词，更自然的交互
- ✅ 移除费用显示，界面更简洁
- ✅ 完善 ffmpeg 和 AMR 安装说明
- ✅ 文档整合优化

### v0.0.1 (2024-10-16)
- ✅ 初始版本发布
- ✅ 支持多模型对话（GPT-4、Claude、Gemini 等）
- ✅ 支持图片分析和生成（DALL-E、Ideogram）
- ✅ 支持语音识别和合成（Whisper、TTS）
- ✅ 企业微信完整对接（加密解密、主动发送）
- ✅ 智能意图识别（语音说"画图"自动识别）
- ✅ 命令大小写不敏感（/TTS 和 /tts 都支持）
- ✅ 消息去重机制（防止重复回复）
- ✅ AMR 音频自动转换（pydub + ffmpeg）
- ✅ 提供管理面板
- ✅ 对话历史管理

## 🔗 相关链接

- [AIHubMix 官网](https://aihubmix.com)
- [AIHubMix 文档](https://docs.aihubmix.com/cn)
- [NotifyHub 项目](https://github.com/your-repo/notifyhub)
- [插件开发指南](../插件开发指南.md)

## 📄 许可证

本插件遵循 MIT 许可证。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

**开发者**: dysobo  
**版本**: 0.0.2  
**更新日期**: 2024-10-17


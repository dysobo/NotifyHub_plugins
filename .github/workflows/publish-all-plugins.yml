name: å‘å¸ƒæ‰€æœ‰æ’ä»¶åŒ…

on:
  workflow_dispatch:
    inputs:
      confirm_publish:
        description: 'ç¡®è®¤å‘å¸ƒæ‰€æœ‰æ’ä»¶åŒ…'
        required: true
        default: 'false'
        type: boolean

jobs:
  publish-plugins:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: è¿è¡Œæ‰“åŒ…è„šæœ¬
      run: |
        python package_plugins.py
        
    - name: æ£€æŸ¥æ‰“åŒ…ç»“æžœ
      run: |
        echo "æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶:"
        ls -la packages/
        echo "æ‰“åŒ…æ–‡ä»¶æ•°é‡:"
        ls packages/*.zip | wc -l
        
    - name: å‘å¸ƒæ‰€æœ‰æ’ä»¶åŒ…
      if: inputs.confirm_publish == true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å¼€å§‹å‘å¸ƒæ‰€æœ‰æ’ä»¶åŒ…..."
        
        plugins=("pill_reminder" "plugin_manager" "qq_bridge" "syno_chat_webhook" "wx_metube")
        
        for plugin in "${plugins[@]}"; do
          echo "å¤„ç†æ’ä»¶: $plugin"
          
          # æŸ¥æ‰¾å¯¹åº”çš„zipæ–‡ä»¶
          zip_file=$(ls packages/${plugin}_*.zip | head -1)
          
          if [ -f "$zip_file" ]; then
            # èŽ·å–æ’ä»¶ä¿¡æ¯
            if [ -f "${plugin}/manifest.json" ]; then
              plugin_name=$(cat ${plugin}/manifest.json | jq -r '.name // "'$plugin'"')
              plugin_version=$(cat ${plugin}/manifest.json | jq -r '.version // "1.0.0"')
              plugin_desc=$(cat ${plugin}/manifest.json | jq -r '.description // "æ— æè¿°"')
            else
              plugin_name="$plugin"
              plugin_version="1.0.0"
              plugin_desc="æ— æè¿°"
            fi
            
            # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
            timestamp=$(date +"%Y.%m.%d")
            tag_name="plugin-${plugin}-${timestamp}"
            
            # åˆ›å»ºReleaseæ ‡é¢˜å’Œæè¿°
            title="${plugin_name} v${plugin_version}"
            description="è‡ªåŠ¨å‘å¸ƒçš„ ${plugin} æ’ä»¶åŒ…

**æ’ä»¶ä¿¡æ¯:**
- åç§°: ${plugin_name}
- ç‰ˆæœ¬: ${plugin_version}
- æè¿°: ${plugin_desc}
- æ›´æ–°æ—¶é—´: $(date)

**å®‰è£…è¯´æ˜Ž:**
1. ä¸‹è½½zipæ–‡ä»¶
2. è§£åŽ‹åˆ°NotifyHubçš„pluginsç›®å½•
3. é‡å¯NotifyHubæœåŠ¡
4. åœ¨æ’ä»¶ç®¡ç†ä¸­å¯ç”¨æ’ä»¶

**æ³¨æ„äº‹é¡¹:**
- è¯·ç¡®ä¿NotifyHubç‰ˆæœ¬å…¼å®¹
- å®‰è£…å‰è¯·å¤‡ä»½çŽ°æœ‰é…ç½®
- å¦‚æœ‰é—®é¢˜è¯·æäº¤Issueåé¦ˆ"
            
            # åˆ›å»ºRelease
            gh release create "$tag_name" "$zip_file" \
              --title "$title" \
              --notes "$description"
            
            echo "âœ… $plugin å‘å¸ƒå®Œæˆ: $tag_name"
          else
            echo "âŒ æ‰¾ä¸åˆ° $plugin çš„æ‰“åŒ…æ–‡ä»¶"
          fi
          
          echo "---"
        done
        
        echo "ðŸŽ‰ æ‰€æœ‰æ’ä»¶å‘å¸ƒå®Œæˆ!"
        
    - name: ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶åˆ°Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: plugin-packages-$(date +%Y%m%d)
        path: packages/*.zip
        retention-days: 30
        
    - name: åˆ›å»ºå‘å¸ƒæ€»ç»“
      run: |
        echo "# ðŸ“¦ æ’ä»¶å‘å¸ƒæ€»ç»“" >> RELEASE_SUMMARY.md
        echo "" >> RELEASE_SUMMARY.md
        echo "å‘å¸ƒæ—¶é—´: $(date)" >> RELEASE_SUMMARY.md
        echo "ä»“åº“åœ°å€: https://github.com/${{ github.repository }}" >> RELEASE_SUMMARY.md
        echo "" >> RELEASE_SUMMARY.md
        echo "## å‘å¸ƒçš„æ’ä»¶åŒ…" >> RELEASE_SUMMARY.md
        echo "" >> RELEASE_SUMMARY.md
        echo "| æ’ä»¶åç§° | æ–‡ä»¶å | å¤§å° | çŠ¶æ€ |" >> RELEASE_SUMMARY.md
        echo "|---------|--------|------|------|" >> RELEASE_SUMMARY.md
        
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            plugin_name=$(echo "$filename" | cut -d'_' -f1)
            size=$(du -h "$zip_file" | cut -f1)
            echo "| $plugin_name | $filename | $size | âœ… å·²å‘å¸ƒ |" >> RELEASE_SUMMARY.md
          fi
        done
        
        echo "" >> RELEASE_SUMMARY.md
        echo "## ä¸‹è½½é“¾æŽ¥" >> RELEASE_SUMMARY.md
        echo "" >> RELEASE_SUMMARY.md
        echo "æ‰€æœ‰æ’ä»¶åŒ…å·²å‘å¸ƒåˆ°: https://github.com/${{ github.repository }}/releases" >> RELEASE_SUMMARY.md
        
        cat RELEASE_SUMMARY.md

name: è‡ªåŠ¨å‘å¸ƒæ’ä»¶åŒ…

on:
  push:
    tags:
      - 'plugin-*'
  workflow_dispatch:
    inputs:
      plugin_name:
        description: 'æ’ä»¶åç§° (pill_reminder, plugin_manager, qq_bridge, syno_chat_webhook, wx_metube)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - pill_reminder
          - plugin_manager
          - qq_bridge
          - syno_chat_webhook
          - wx_metube

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
        
    - name: è¿è¡Œæ‰“åŒ…è„šæœ¬
      run: |
        python package_plugins.py
        
    - name: æ£€æŸ¥æ‰“åŒ…ç»“æžœ
      run: |
        echo "æ£€æŸ¥æ‰“åŒ…æ–‡ä»¶:"
        ls -la packages/
        echo "æ‰“åŒ…æ–‡ä»¶æ•°é‡:"
        ls packages/*.zip | wc -l
        
    - name: åˆ›å»ºGitHub Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/plugin-')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # èŽ·å–æ ‡ç­¾å
        TAG_NAME=${GITHUB_REF#refs/tags/}
        PLUGIN_NAME=${TAG_NAME#plugin-}
        
        echo "å‘å¸ƒæ’ä»¶: $PLUGIN_NAME"
        
        # æŸ¥æ‰¾å¯¹åº”çš„zipæ–‡ä»¶
        ZIP_FILE=$(ls packages/${PLUGIN_NAME}_*.zip | head -1)
        
        if [ -f "$ZIP_FILE" ]; then
          # åˆ›å»ºRelease
          gh release create "$TAG_NAME" "$ZIP_FILE" \
            --title "${PLUGIN_NAME^} æ’ä»¶åŒ…" \
            --notes "è‡ªåŠ¨å‘å¸ƒçš„ ${PLUGIN_NAME} æ’ä»¶åŒ…
          
          æ›´æ–°æ—¶é—´: $(date)
          ä»“åº“åœ°å€: https://github.com/${{ github.repository }}
          
          å®‰è£…è¯´æ˜Ž:
          1. ä¸‹è½½zipæ–‡ä»¶
          2. è§£åŽ‹åˆ°NotifyHubçš„pluginsç›®å½•
          3. é‡å¯NotifyHubæœåŠ¡
          4. åœ¨æ’ä»¶ç®¡ç†ä¸­å¯ç”¨æ’ä»¶"
          
          echo "âœ… $PLUGIN_NAME å‘å¸ƒå®Œæˆ"
        else
          echo "âŒ æ‰¾ä¸åˆ° $PLUGIN_NAME çš„æ‰“åŒ…æ–‡ä»¶"
          exit 1
        fi
        
    - name: æ‰‹åŠ¨å‘å¸ƒæ‰€æœ‰æ’ä»¶
      if: github.event_name == 'workflow_dispatch' && inputs.plugin_name == 'all'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å‘å¸ƒæ‰€æœ‰æ’ä»¶åŒ…"
        
        plugins=("pill_reminder" "plugin_manager" "qq_bridge" "syno_chat_webhook" "wx_metube")
        
        for plugin in "${plugins[@]}"; do
          echo "å¤„ç†æ’ä»¶: $plugin"
          
          # æŸ¥æ‰¾å¯¹åº”çš„zipæ–‡ä»¶
          ZIP_FILE=$(ls packages/${plugin}_*.zip | head -1)
          
          if [ -f "$ZIP_FILE" ]; then
            # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
            VERSION=$(date +"%Y.%m.%d")
            TAG_NAME="plugin-${plugin}-${VERSION}"
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
            if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
              echo "æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi
            
            # åˆ›å»ºRelease
            gh release create "$TAG_NAME" "$ZIP_FILE" \
              --title "${plugin^} v${VERSION}" \
              --notes "è‡ªåŠ¨å‘å¸ƒçš„ ${plugin} æ’ä»¶åŒ…
            
            æ›´æ–°æ—¶é—´: $(date)
            ä»“åº“åœ°å€: https://github.com/${{ github.repository }}
            
            å®‰è£…è¯´æ˜Ž:
            1. ä¸‹è½½zipæ–‡ä»¶
            2. è§£åŽ‹åˆ°NotifyHubçš„pluginsç›®å½•
            3. é‡å¯NotifyHubæœåŠ¡
            4. åœ¨æ’ä»¶ç®¡ç†ä¸­å¯ç”¨æ’ä»¶"
            
            echo "âœ… $plugin å‘å¸ƒå®Œæˆ: $TAG_NAME"
          else
            echo "âŒ æ‰¾ä¸åˆ° $plugin çš„æ‰“åŒ…æ–‡ä»¶"
          fi
        done
        
    - name: æ‰‹åŠ¨å‘å¸ƒå•ä¸ªæ’ä»¶
      if: github.event_name == 'workflow_dispatch' && inputs.plugin_name != 'all'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PLUGIN_NAME=${{ inputs.plugin_name }}
        echo "å‘å¸ƒæ’ä»¶: $PLUGIN_NAME"
        
        # æŸ¥æ‰¾å¯¹åº”çš„zipæ–‡ä»¶
        ZIP_FILE=$(ls packages/${PLUGIN_NAME}_*.zip | head -1)
        
        if [ -f "$ZIP_FILE" ]; then
          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
          VERSION=$(date +"%Y.%m.%d")
          TAG_NAME="plugin-${PLUGIN_NAME}-${VERSION}"
          
          # åˆ›å»ºRelease
          gh release create "$TAG_NAME" "$ZIP_FILE" \
            --title "${PLUGIN_NAME^} v${VERSION}" \
            --notes "è‡ªåŠ¨å‘å¸ƒçš„ ${PLUGIN_NAME} æ’ä»¶åŒ…
          
          æ›´æ–°æ—¶é—´: $(date)
          ä»“åº“åœ°å€: https://github.com/${{ github.repository }}
          
          å®‰è£…è¯´æ˜Ž:
          1. ä¸‹è½½zipæ–‡ä»¶
          2. è§£åŽ‹åˆ°NotifyHubçš„pluginsç›®å½•
          3. é‡å¯NotifyHubæœåŠ¡
          4. åœ¨æ’ä»¶ç®¡ç†ä¸­å¯ç”¨æ’ä»¶"
          
          echo "âœ… $PLUGIN_NAME å‘å¸ƒå®Œæˆ: $TAG_NAME"
        else
          echo "âŒ æ‰¾ä¸åˆ° $PLUGIN_NAME çš„æ‰“åŒ…æ–‡ä»¶"
          exit 1
        fi
        
    - name: ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶åˆ°Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: plugin-packages
        path: packages/*.zip
        
    - name: æ›´æ–°READMEå‘å¸ƒä¿¡æ¯
      run: |
        echo "## ðŸ“¦ æœ€æ–°å‘å¸ƒ" >> RELEASE_INFO.md
        echo "" >> RELEASE_INFO.md
        echo "| æ’ä»¶åç§° | ç‰ˆæœ¬ | å‘å¸ƒæ—¶é—´ | ä¸‹è½½é“¾æŽ¥ |" >> RELEASE_INFO.md
        echo "|---------|------|----------|----------|" >> RELEASE_INFO.md
        
        for zip_file in packages/*.zip; do
          if [ -f "$zip_file" ]; then
            filename=$(basename "$zip_file")
            plugin_name=$(echo "$filename" | cut -d'_' -f1)
            version=$(echo "$filename" | cut -d'_' -f2)
            timestamp=$(echo "$filename" | cut -d'_' -f3 | cut -d'.' -f1)
            
            echo "| $plugin_name | $version | $timestamp | [ä¸‹è½½]($zip_file) |" >> RELEASE_INFO.md
          fi
        done

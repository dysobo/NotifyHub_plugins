# wx_metube 插件日志优化说明

## 问题描述
wx_metube 插件每隔5分钟就全面检查已下载完成的信息，产生大量重复的日志，影响系统日志的可读性。

## 优化方案

### 1. 建立缓存机制
- 新增 `download_count_cache` 缓存，记录上次检查的下载完成数量
- 缓存TTL设置为24小时，确保数据及时更新

### 2. 智能检查逻辑
- **首次运行**：执行全量检查，记录当前下载完成数量
- **数量未增加**：如果下载完成数量没有变化，跳过检查，避免重复日志
- **数量增加**：检测到新的完成下载，执行检查并处理
- **跨天检查**：每天至少执行一次全量检查，防止遗漏

### 3. 日志优化
- 减少不必要的调试日志输出
- 只在有活跃任务或发现新完成下载时输出状态日志
- 全量检查时输出更详细的调试信息

### 4. 新增API接口
- `POST /reset-download-count-cache`：重置下载数量缓存，强制下次全量检查
- `GET /cache-status`：查看各种缓存的状态信息

## 优化效果

### 优化前
```
每5分钟输出：
- 检查已完成下载数量: X
- 下载已完成且已处理过，跳过: URL1
- 下载已完成且已处理过，跳过: URL2
- ... (重复大量相同日志)
```

### 优化后
```
正常情况（无新下载）：
- 下载完成数量未增加（当前：X，上次：X），跳过检查

有新下载时：
- 发现新的已完成下载: URL
- 本次处理了 1 个新的已完成下载

跨天时：
- 跨天检测，执行全量检查已完成下载
```

## 技术实现

### 核心逻辑
```python
# 获取上次检查的下载数量
last_count = download_count_cache.get('last_completed_count', 0)
last_check_date = download_count_cache.get('last_full_check_date')

# 检查是否需要全量检查（每天一次）
need_full_check = False
if last_check_date is None:
    need_full_check = True  # 首次运行
elif current_time.date() > last_check_date.date():
    need_full_check = True  # 跨天

# 如果下载数量没有增加且不需要全量检查，则跳过
if not need_full_check and current_count <= last_count:
    logger.debug(f"下载完成数量未增加，跳过检查")
    return
```

### 缓存管理
- `download_count_cache`：记录下载数量变化，TTL=24小时
- `processed_downloads_cache`：记录已处理的下载，TTL=7天
- `download_cache`：记录下载任务信息，TTL=24小时

## 配置说明

### 缓存配置
```python
download_count_cache = Cache(maxsize=10, ttl=86400)  # 下载数量缓存24小时
processed_downloads_cache = Cache(maxsize=10000, ttl=604800)  # 已处理下载缓存7天
download_cache = Cache(maxsize=5000, ttl=86400)  # 下载记录缓存24小时
```

### 检查频率
- 定时任务：每5分钟执行一次检查
- 实际检查：根据缓存机制智能判断是否需要检查
- 全量检查：每天至少一次，防止遗漏

## 使用方法

### 查看缓存状态
```bash
GET /api/plugins/wx_metube/cache-status
```

### 重置缓存（强制全量检查）
```bash
POST /api/plugins/wx_metube/reset-download-count-cache
```

### 手动检查下载状态
```bash
POST /api/plugins/wx_metube/manual-check
```

## 注意事项

1. **首次运行**：插件首次启动时会执行全量检查
2. **跨天检查**：每天会自动执行一次全量检查
3. **缓存清理**：缓存会在TTL到期后自动清理
4. **日志级别**：建议将日志级别设置为INFO或DEBUG以查看优化效果

## 测试验证

已通过测试脚本验证以下场景：
- ✅ 首次运行全量检查
- ✅ 下载数量未增加时跳过检查
- ✅ 下载数量增加时执行检查
- ✅ 跨天时执行全量检查
- ✅ 已处理下载的缓存机制

优化完成后，系统日志将大幅减少，只在真正有变化时才输出相关日志，提高日志的可读性和系统的运行效率。
